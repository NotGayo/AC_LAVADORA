;====================================VARIABLES===========================================================
	
ESTADO EQU 0x20
EVENTO EQU 0x21
VALOR_DISPLAY EQU 0x22
;------------------TICKS--------------
TICK_INT_0 EQU 0x23.0
TICK_ADC_0 EQU 0x23.1
TICK_ADC_1 EQU 0x23.2
TICK_TIMER_0 EQU 0x23.3
;-----------SENSORES Y ACTIVACIONES-----------------
MOTOR_DESAGUE EQU P1.0
PUERTA_ABIERTA EQU P1.1
SENSOR_LLENADO EQU P1.2
SENSOR_VACIADO EQU P1.3
BIT1_TEMP EQU P3.1
BIT0_TEMP EQU P3.0
VALV_ENTRADA_AGUA EQU P3.3
CALENTADOR_AGUA EQU P3.6
SENTIDO_GIRO_MOTOR EQU P2.7
;-------------REGISTROS IMPORTANTES-------------------------------
ADCON EQU 0xC5

;======================================INCIO================================================

ORG 0x0000
	AJMP INICIO
ORG 0X0003
	AJMP INT0_ISR
ORG 0X0053
	AJMP ADC_ISR
ORG 0X007b

INICIO:
	ACALL INICIALIZACIONES

MAIN:					;LAZO PRINCIPAL
	ACALL MAQ_ESTADOS
	AJMP MAIN

MAQ_ESTADOS:
	MOV A, ESTADO
	RL A
	MOV DPTR, #LISTA_EST
	JMP @A+DPTR
LISTA_EST:
	AJMP ESTADO_0 ; REPOSO
	AJMP ESTADO_1 ; COMPROBACION SOBREPESO
	AJMP ESTADO_2 ; PUERTA ABIERTA
	AJMP ESTADO_3 ; LLENANDO
	AJMP ESTADO_4 ; CALENTAR CUBA
	AJMP ESTADO_5 ; LAVADO
	AJMP ESTADO_6 ; VACIAR AGUA
	AJMP ESTADO_7 ; CENTRIFUGAR
	AJMP ESTADO_8 ; FIN

;================================INICIALIZACIONES====================================================================

INICIALIZACIONES:

	MOV ESTADO, #0
	MOV EVENTO, #0
	MOV VALOR_DISPLAY, #0
	SETB IE.0	;ACTIVAMOS LA INT0	
	SETB TICK_INT_0 ;TICK A NIVEL BAJO POR ELLO SE INICIA A 1
	
	RET	
;=====================================================================================================

;LLAMAMOS AL GENERADOR DE EVENTOS PARA QUE ASI NOS DIGA A CUAL DEBEMOS IR EN EL ESTADO DEL SISTEMA QUE NOS ENCONTRAMOS

ESTADO_0:
	ACALL GEN_EV_0
	ACALL MQ_EVEN_0 	;REPOSO
	RET

ESTADO_1:
	ACALL GEN_EV_1
	ACALL MQ_EVEN_1		;COMPROBANDO SP
	RET

ESTADO_2:
	ACALL MQ_EVEN_2
	RET

ESTADO_3:
	ACALL MQ_EVEN_3
	RET
ESTADO_4:
	ACALL MQ_EVEN_4
	RET

ESTADO_5:
	ACALL MQ_EVEN_5
	RET

ESTADO_6:
	ACALL MQ_EVEN_6
	RET

ESTADO_7:
	ACALL MQ_EVEN_7
	RET
ESTADO_8:
	ACALL MQ_EVEN_8
	RET


;===============================================ESTADO 0 - REPOSO======================================================
MQ_EVEN_0:
	;PONEMOS EL IDLE
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_0
	JMP @A+DPTR
LIST_EVEN_MQEV_0:
	AJMP ME0_EV_0 ; Evento 0
	AJMP ME0_EV_1 ; Evento 1
	AJMP ME0_EV_2 ; Evento 2
ME0_EV_0:
	RET
ME0_EV_1:
	;---	;ENCENDIO Y PUERTA ABIERTA
	CLR IE.0
	MOV ESTADO, #02H
	RET
ME0_EV_2:
	;---	;ENCENDIO Y PUERTA CERRADA
	CLR IE.0
	SETB IE.7
	SETB IE.6
	ACALL ACTIVAR_ADC_PESO
	CLR P3.2
	MOV ESTADO, #01H
	RET

;===========================================ESTADO 1 - COMPROBANDO SP==========================================================
MQ_EVEN_1:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_1
	JMP @A+DPTR
LIST_EVEN_MQEV_1:
	AJMP ME1_EV_0 ; Evento 0
	AJMP ME1_EV_1 ; Se pulsa p3.2 apagar ir a estado 0
	AJMP ME1_EV_2 ; Se abre la puerta
	AJMP ME1_EV_3 ; salta adc y sobre peso
	AJMP ME1_EV_4 ; salta adc, peso ok y p1.4
ME1_EV_0:
	RET
ME1_EV_1:	;PULSA ENCENDIDO DE NUEVO
	MOV ESTADO, #0x00
	RET
ME1_EV_2:	;PUERTA ABIERTA
	MOV DISPLAY_0, #77H
	MOV DISPLAY_1, #73H
	AJMP CARGAR_DISPLAYS
	RET
ME1_EV_3:	;HAY SOBREPESO
	RET
ME1_EV_4:	;NO SOBREPESO Y ENCENDIDO
	RET
;==========================================ESTADO 2 - PUERTA ABIERTA===========================================================

MQ_EVEN_2:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_2
	JMP @A+DPTR
LIST_EVEN_MQEV_2:
	AJMP ME2_EV_0 ; Evento 0
	AJMP ME2_EV_1 ; Descripción Maq. Event. 0. Evento 1
ME2_EV_0:
	RET
ME2_EV_1:	;PUERTA CERRADA
	RET

;==========================================ESTADO 3 - LLENADO===========================================================

MQ_EVEN_3:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_3
	JMP @A+DPTR
LIST_EVEN_MQEV_3:
	AJMP ME3_EV_0 ; Evento 0
	AJMP ME3_EV_1 
ME3_EV_0:
	RET
ME3_EV_1:	;CUBA LLENA
	RET

;==========================================ESTADO 4 - CALENTAMIENTO CUBA===========================================================

MQ_EVEN_4:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_4
	JMP @A+DPTR
LIST_EVEN_MQEV_4:
	AJMP ME4_EV_0 ; Evento 0
	AJMP ME4_EV_1
	AJMP ME4_EV_2 
ME4_EV_0:
	RET
ME4_EV_1:	; NO CALIENTE
	RET
ME4_EV_2:	; AGUA CALIENTE
	RET

;==========================================ESTADO 5 - LAVADO===========================================================

MQ_EVEN_5:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_5
	JMP @A+DPTR
LIST_EVEN_MQEV_5:
	AJMP ME5_EV_0 ; Evento 0
	AJMP ME5_EV_1
	AJMP ME5_EV_2
	AJMP ME5_EV_3 
ME5_EV_0:
	RET
ME5_EV_1:	; PASA 1 MIN
	RET
ME5_EV_2:	; PASAN 15s
	RET
ME5_EV_3:	; PASAN 50 MIN
	RET

;==========================================ESTADO 6 - VACIAR AGUA===========================================================

MQ_EVEN_6:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_6
	JMP @A+DPTR
LIST_EVEN_MQEV_6:
	AJMP ME6_EV_0 ; Evento 0
	AJMP ME6_EV_1
ME6_EV_0:
	RET
ME6_EV_1:	; CUBA VACIA
	RET

;==========================================ESTADO 7 - CENTRIFUGAR===========================================================

MQ_EVEN_7:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_7
	JMP @A+DPTR
LIST_EVEN_MQEV_7:
	AJMP ME7_EV_0 ; Evento 0
	AJMP ME7_EV_1
ME7_EV_0:
	RET
ME7_EV_1:	; PASAN 10 MIN
	RET

;==========================================ESTADO 8 - FIN===========================================================

MQ_EVEN_8:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_8
	JMP @A+DPTR
LIST_EVEN_MQEV_8:
	AJMP ME8_EV_0 ; Evento 0
	AJMP ME8_EV_1
ME8_EV_0:
	RET
ME8_EV_1:	; PUERTA ABIERTA
	RET

;==============================================GENERADORES DE EVENTOS=======================================================

GEN_EV_0:
	;CONDICIONES ESTADO 0
	JB P3.2, COMPROBAR_PUERTA	;SI NO ESTA EL BOTON NI NOS MOLESTAMOS EN VER EL RESTO DE CONDICIONES 
	MOV EVENTO, #00H		;ESTAMOS SEGURO EN ESTADO 0 SI NO ESTA P3.2
	RET

COMPROBAR_PUERTA:
	JB PUERTA_ABIERTA, GEN_EV_1_ES_0
	AJMP GEN_EV_2_ES_0

GEN_EV_1_ES_0:
	MOV EVENTO, #01H		;EN EL CASO DE QUE SI ESTE LA PUERTA ABIERTA EVENTO 1 ESTADO 0
	RET

GEN_EV_2_ES_0:
	MOV EVENTO, #02H		;EN EL CASO DE QUE SI ESTE LA PUERTA ABIERTA EVENTO 2 ESTADO 0
	RET



;------------------------------------------------------------------------------------------------------------------

GEN_EV_1:
	;CONDICIONES ESTADO 1
	JB P3.2, GEN_EV_1_ES_1
	JB PUERTA_ABIERTA, GEN_EV_2_ES_1
	;ADC
	RET

GEN_EV_1_ES_1:
	MOV EVENTO, #01H
	RET
GEN_EV_2_ES_1:
	MOV EVENTO, #02H
	RET
GEN_EV_3_ES_1:
	CLR TICK_ADC_0
	MOV EVENTO, #03H
	RET
GEN_EV_4_ES_1:
	CLR TICK_ADC_0
	MOV EVENTO, #04H
	RET
;------------------------------------------------------------------------------------------------------------------

GEN_EV_2:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_3:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_4:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_5:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_6:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_7:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------

GEN_EV_8:
	;CONDICIONES ESTADO 0
	
	RET


;------------------------------------------------------------------------------------------------------------------
;================================================ACCIONES=======================================================

ACTIVAR_ADC_PESO:
	ANL ADCON,#0xE8
	ORL ADCON,#0x08

;==============================================INTERRUPCIONES=======================================================

INT0_ISR:
	PUSH PSW
	PUSH ACC
	CLR TICK_INT_0
	POP PSW
	POP ACC
	RETI

ADC_ISR:
	PUSH PSW
	PUSH ACC
	SETB TICK_ADC_0
	ANL ADCON, #0XF0
	POP PSW
	POP ACC
	RETI
;==============================================FIN======================================================
END
